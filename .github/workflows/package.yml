name: Build & Package RetroArch

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: write

jobs:
  build-base:
    name: Build Base Image
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Base Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfiles/base.Dockerfile
          push: true
          tags: ghcr.io/unclejunvip/retroarch-tg5040/retroarch-base:latest
          cache-from: type=registry,ref=ghcr.io/unclejunvip/retroarch-tg5040/retroarch-base:buildcache
          cache-to: type=registry,ref=ghcr.io/unclejunvip/retroarch-tg5040/retroarch-base:buildcache,mode=max


  build-retroarch:
    name: Build RetroArch
    needs: build-base
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build RetroArch
        run: |
          docker build -f Dockerfiles/retroarch.Dockerfile \
            --build-arg BASE_IMAGE=ghcr.io/unclejunvip/retroarch-tg5040/retroarch-base:latest \
            -t retroarch-tg5040:latest .
          mkdir -p build/RetroArch/lib
          docker create --name retroarch-temp retroarch-tg5040:latest
          docker cp retroarch-temp:/home/builder/out/retroarch build/RetroArch/ 2>/dev/null || true
          docker cp retroarch-temp:/home/builder/out/lib/libxkbcommon.so.0 build/RetroArch/lib/ 2>/dev/null || true
          docker rm retroarch-temp

      - name: Upload RetroArch Binary
        uses: actions/upload-artifact@v4
        with:
          name: retroarch-binary
          path: |
            build/RetroArch/retroarch
            build/RetroArch/lib/
          retention-days: 1

  build-cores:
    name: Build ${{ matrix.core }}
    needs: build-base
    runs-on: ubuntu-22.04-arm
    strategy:
      matrix:
        core: [ snes9x, genesis_plus_gx, gambatte, fceumm, nestopia, pcsx_rearmed, mgba, gpsp ]
      max-parallel: 4
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ${{ matrix.core }}
        run: |
          mkdir -p build/RetroArch/cores/info
          docker build -f Dockerfiles/cores/${{ matrix.core }}.Dockerfile \
            --build-arg BASE_IMAGE=ghcr.io/unclejunvip/retroarch-tg5040/retroarch-base:latest \
            -t retroarch-core-${{ matrix.core }}:latest .
          docker create --name core-temp-${{ matrix.core }} retroarch-core-${{ matrix.core }}:latest
          docker cp core-temp-${{ matrix.core }}:/home/builder/out/. build/RetroArch/cores/ 2>/dev/null || true
          docker rm core-temp-${{ matrix.core }}

      - name: Upload Core ${{ matrix.core }}
        uses: actions/upload-artifact@v4
        with:
          name: retroarch-core-${{ matrix.core }}
          path: |
            build/RetroArch/cores/${{ matrix.core }}_libretro.so
            build/RetroArch/cores/info/${{ matrix.core }}_libretro.info
          retention-days: 1

  package:
    name: Package Release
    needs: [ build-retroarch, build-cores ]
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Download RetroArch Binary
        uses: actions/download-artifact@v4
        with:
          name: retroarch-binary
          path: build/RetroArch/

      - name: Download Cores
        uses: actions/download-artifact@v4
        with:
          pattern: retroarch-core-*
          path: build/RetroArch/cores/
          merge-multiple: true

      - name: Organize Core Files
        run: |
          mkdir -p build/RetroArch/cores/info
          find build/RetroArch/cores -maxdepth 1 -name "*.info" -exec mv {} build/RetroArch/cores/info/ \;

      - name: Debug Directory Structure
        run: |
          echo "=== build/RetroArch structure ==="
          find build/RetroArch -type f | head -20
          echo "=== build/RetroArch/cores structure ==="
          find build/RetroArch/cores -type f 2>/dev/null | head -20

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Package
        run: task package

      - name: Upload Final Package
        uses: actions/upload-artifact@v4
        with:
          name: RetroArch.pak
          path: build/RetroArch.pak/
          retention-days: 3

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/RetroArch.pak/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}